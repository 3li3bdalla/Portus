<!DOCTYPE html>
<html>
  <head>
    <title>Configuring a secure private registry</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Creating the Registry">

    <link href="/stylesheets/portus.css"  type="text/css" rel="stylesheet" />
    <script src="/javascripts/dist/portus.min.js" type="text/javascript" charset="utf-8"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
  <script src="//oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="//oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->

<!-- Favicon for all different devices -->
<meta content="width=device-width, initial-scale=1" name="viewport" />
<link href="/images/favicon/apple-touch-icon-57x57.png" rel="apple-touch-icon" sizes="57x57" />
<link href="/images/favicon/apple-touch-icon-60x60.png" rel="apple-touch-icon" sizes="60x60" />
<link href="/images/favicon/apple-touch-icon-72x72.png" rel="apple-touch-icon" sizes="72x72" />
<link href="/images/favicon/apple-touch-icon-76x76.png" rel="apple-touch-icon" sizes="76x76" />
<link href="/images/favicon/apple-touch-icon-114x114.png" rel="apple-touch-icon" sizes="114x114" />
<link href="/images/favicon/apple-touch-icon-120x120.png" rel="apple-touch-icon" sizes="120x120" />
<link href="/images/favicon/apple-touch-icon-144x144.png" rel="apple-touch-icon" sizes="144x144" />
<link href="/images/favicon/apple-touch-icon-152x152.png" rel="apple-touch-icon" sizes="152x152" />
<link href="/images/favicon/apple-touch-icon-180x180.png" rel="apple-touch-icon" sizes="180x180" />
<link href="/images/favicon/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png" />
<link href="/images/favicon/android-chrome-192x192.png" rel="icon" sizes="192x192" type="image/png" />
<link href="/images/favicon/favicon-96x96.png" rel="icon" sizes="96x96" type="image/png" />
<link href="/images/favicon/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png" />
<link href="/images/favicon/manifest.json" rel="manifest" />
<link color="#205683" href="/images/favicon/safari-pinned-tab.svg" rel="mask-icon" />
<link href="/images/favicon/favicon.ico" rel="shortcut icon" />
<meta content="Portus" name="apple-mobile-web-app-title" />
<meta content="Portus" name="application-name" />
<meta content="#da532c" name="msapplication-TileColor" />
<meta content="/images/favicon/mstile-144x144.png" name="msapplication-TileImage" />
<meta content="/images/favicon/browserconfig.xml" name="msapplication-config" />
<meta content="#205683" name="theme-color" />

  </head>
  <body>
    <header id="portus-header" class="portus-topbar">
  <div class="container-fluid">
    <i id="open_main_menu" class="fa fa-bars fa-2x visible-xs menu-sandwich"></i>

    <a href="/">
      <img class="pull-left img-responsive topbar-logo" src="/images/logo-header.png" alt="Logo on header">
    </a>
    <div class="pull-right hidden-xs">
      <a class="btn btn-link" href="/blog/index.html">Blog</a>
      <a class="btn btn-link" href="/features.html">Features</a>
      <a class="btn btn-link" href="/documentation.html">Documentation</a>
    </div>
    <div class="clearfix"></div>
  </div>
</header>

<div id="mobile-menu" class="visible-xs mobile-menu">
  <ul>
    <li><i class="fa fa-list-ul"></i><a class="btn btn-link" href="/features.html">Features</a></li>
    <li><i class="fa fa-book"></i><a class="btn btn-link" href="/documentation.html">Documentation</a></li>
    <li><i class="fa fa-newspaper-o"></i><a class="btn btn-link" href="/blog/index.html">Blog</a></li>
    <li><i class="fa fa-question-circle"></i><a class="btn btn-link" href="/docs/FAQ.html">FAQ</a></li>
  </ul>
</div>

    <div class="container" id="documentation">
      <div class="row">
        <div class="post-content col-md-10 col-md-offset-3 col-sm-12 col-xs-12">
          <section>
            <div class="row">
              <div class="visible-xs visible-sm">
  <div class="content-bar">
    <ul class="topics">
      <li class="dropdown">
        <button class="dropdown-toggle" type="button" data-toggle="dropdown">Documentation Index
        <span class="caret"></span></button>
        <ul class="dropdown-menu">
          <li class="dropdown-header">Documentation</li>
          
          
            <li>
              <a href="/docs/first-steps.html">
                Docker and Portus for newcomers
              </a>
            </li>
          
            <li>
              <a href="/docs/Configuring-Portus.html">
                Configuring Portus
              </a>
            </li>
          
            <li>
              <a href="/docs/database.html">
                Configuring the database
              </a>
            </li>
          
            <li>
              <a href="/docs/How-to-setup-secure-registry.html">
                Configuring a secure private registry
              </a>
            </li>
          
            <li>
              <a href="/docs/deploy.html">
                Deploying Portus
              </a>
            </li>
          
            <li>
              <a href="/docs/Configuring-the-registry.html">
                Portus and your private registry
              </a>
            </li>
          
            <li>
              <a href="/docs/assets.html">
                Managing assets
              </a>
            </li>
          
            <li>
              <a href="/docs/secrets.html">
                Using secrets
              </a>
            </li>
          
            <li>
              <a href="/docs/API.html">
                Portus REST API
              </a>
            </li>
          
            <li>
              <a href="/docs/background.html">
                The background process
              </a>
            </li>
          
            <li>
              <a href="/docs/portusctl.html">
                portusctl
              </a>
            </li>
          
            <li>
              <a href="/docs/upgrading-portus.html">
                Upgrading Portus
              </a>
            </li>
          
            <li>
              <a href="/docs/versions.html">
                Supported Docker Versions
              </a>
            </li>
          
            <li>
              <a href="/docs/debugging.html">
                Debugging Portus
              </a>
            </li>
          
            <li>
              <a href="/docs/how_we_release.html">
                Portus Releases
              </a>
            </li>
          
            <li>
              <a href="/docs/migrate-from-rpm.html">
                Migrating from the RPM
              </a>
            </li>
          
            <li>
              <a href="/docs/release-schedule.html">
                Release schedule
              </a>
            </li>
          
            <li>
              <a href="/docs/FAQ.html">
                FAQ
              </a>
            </li>
          
          <li class="dropdown-header">Features</li>
          
          
            <li>
              <a href="/features/1_Synchronizing-the-Registry-and-Portus.html">
                Synchonizing the Registry and Portus
              </a>
            </li>
          
            <li>
              <a href="/features/2_LDAP-support.html">
                LDAP support
              </a>
            </li>
          
            <li>
              <a href="/features/3_teams_namespaces_and_users.html">
                Teams, namespaces and users
              </a>
            </li>
          
            <li>
              <a href="/features/4_audit.html">
                Audit
              </a>
            </li>
          
            <li>
              <a href="/features/5_search.html">
                Search
              </a>
            </li>
          
            <li>
              <a href="/features/6_security_scanning.html">
                Security scanning
              </a>
            </li>
          
            <li>
              <a href="/features/removing_images.html">
                Removing images and tags
              </a>
            </li>
          
            <li>
              <a href="/features/6_starring.html">
                Starring repositories
              </a>
            </li>
          
            <li>
              <a href="/features/7_disabling_users.html">
                Removing/Disabling users
              </a>
            </li>
          
            <li>
              <a href="/features/anonymous_browsing.html">
                Anonymous browsing
              </a>
            </li>
          
            <li>
              <a href="/features/8_locking.html">
                Locking accounts for safety reasons
              </a>
            </li>
          
            <li>
              <a href="/features/9_recovering_password.html">
                Recovering the password
              </a>
            </li>
          
            <li>
              <a href="/features/disabling_signup.html">
                Disabling the sign up form
              </a>
            </li>
          
            <li>
              <a href="/features/oauth.html">
                OAuth and OpenID Connect support
              </a>
            </li>
          
            <li>
              <a href="/features/application_tokens.html">
                Application tokens
              </a>
            </li>
          
            <li>
              <a href="/features/display_name.html">
                Display name
              </a>
            </li>
          
            <li>
              <a href="/features/health.html">
                Health checking
              </a>
            </li>
          
        </ul>
      </li>
    </ul>
  </div>
</div>

            </div>
            <div class="row post">
              <article>
                <h2 id="creating-the-registry">Creating the Registry</h2>

<h3 id="docker-distribution">Docker Distribution</h3>

<p>The Docker Registry is a service that can talk to the docker daemon in order to
upload and download docker images. Since version 2, the docker registry is
called Distribution, and you can find the documentation
<a href="https://www.docker.com/docker-registry">here</a>.</p>

<p>There are multiple ways to deploy your own private registry. This page
<a href="https://docs.docker.com/registry/deploying/">explains</a> how to do this. From a
deployment point of view, the only thing important for Portus is that it should
be reachable. Note that this will be checked when adding your registry into
Portus’ database, as explained <a href="/docs/Configuring-the-registry.html">here</a>.</p>

<h3 id="configuring-the-registry-in-a-safe-way">Configuring the Registry in a safe way</h3>

<p>Once you have your registry in place, you need to configure it. This can be
done either through the <code class="highlighter-rouge">/etc/registry/config.yml</code> file or through <a href="https://github.com/docker/distribution/blob/master/docs/configuration.md#override-specific-configuration-options">environment
variables</a>.
For convenience, we will assume that you have access to the <code class="highlighter-rouge">config.yml</code> file.
This is a config example:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">version</span><span class="pi">:</span> <span class="s">0.1</span>
<span class="na">loglevel</span><span class="pi">:</span> <span class="s">debug</span>
<span class="na">storage</span><span class="pi">:</span>
  <span class="na">filesystem</span><span class="pi">:</span>
    <span class="na">rootdirectory</span><span class="pi">:</span> <span class="s">/var/lib/docker-registry</span>
  <span class="na">delete</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
<span class="na">http</span><span class="pi">:</span>
  <span class="na">addr</span><span class="pi">:</span> <span class="s">:5000</span>
  <span class="na">tls</span><span class="pi">:</span>
    <span class="na">certificate</span><span class="pi">:</span> <span class="s">/etc/nginx/ssl/my.registry.crt</span>
    <span class="na">key</span><span class="pi">:</span> <span class="s">/etc/nginx/ssl/my.registry.key</span>
<span class="na">auth</span><span class="pi">:</span>
  <span class="na">token</span><span class="pi">:</span>
    <span class="na">realm</span><span class="pi">:</span> <span class="s">https://my.portus/v2/token</span>
    <span class="na">service</span><span class="pi">:</span> <span class="s">my.registry:5000</span>
    <span class="na">issuer</span><span class="pi">:</span> <span class="s">my.portus</span>
    <span class="na">rootcertbundle</span><span class="pi">:</span> <span class="s">/etc/nginx/ssl/my.registry.crt</span>
<span class="na">notifications</span><span class="pi">:</span>
  <span class="na">endpoints</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">portus</span>
      <span class="na">url</span><span class="pi">:</span> <span class="s">https://my.portus/v2/webhooks/events</span>
      <span class="na">timeout</span><span class="pi">:</span> <span class="s">500ms</span>
      <span class="na">threshold</span><span class="pi">:</span> <span class="s">5</span>
      <span class="na">backoff</span><span class="pi">:</span> <span class="s">1s</span></code></pre></figure>

<p>Some things to note:</p>

<ul>
  <li>The <strong>loglevel</strong> is set to <code class="highlighter-rouge">debug</code>. You usually want to relax this as specified
<a href="https://github.com/docker/distribution/blob/master/docs/configuration.md#log">here</a>.</li>
  <li>The <strong>storage</strong> has been configured to be on the filesystem. This is a pretty
basic and standard setup, but you can tweak it as much as you need. Just take a
look at <a href="https://github.com/docker/distribution/blob/master/docs/configuration.md#storage">this document</a>
to learn all of the supported options. Also note that <code class="highlighter-rouge">deleted</code> has been set
to <code class="highlighter-rouge">true</code>. Even if this is not a requirement from Portus’ side, it might be
in the future when removing images is supported.</li>
  <li>The <strong>http</strong> config is set to listen to the <code class="highlighter-rouge">:5000</code> port, which is the default
value. Also note that in the <code class="highlighter-rouge">tls</code> configurable value we provide a
certificate and a key. This will be used so the communication between the
docker daemon and the registry is done through TLS. We <em>strongly</em> recommend
to use this, otherwise we cannot guarantee that the communication will be
secure.</li>
  <li>The <strong>auth</strong> value defines the communication between Portus and this
registry. Some important things to note:
    <ul>
      <li>The <strong>issuer</strong> should be the same as the one defined by <code class="highlighter-rouge">machine_fqdn</code> in
the <code class="highlighter-rouge">config/config.yml</code> file. This can be changed with the <code class="highlighter-rouge">PORTUS_MACHINE_FQDN</code>
environment variable.</li>
      <li>The <strong>rootcertbundle</strong> should point to the same location as the
<code class="highlighter-rouge">encryption_private_key_path</code> configurable value as defined also in the
<code class="highlighter-rouge">config/secrets.yml</code> file. This can be also tweaked with the <code class="highlighter-rouge">PORTUS_KEY_PATH</code>
environment variable.</li>
    </ul>
  </li>
  <li>The <strong>notifications</strong> configuration tells your registry where to send
notifications. In this case, you should specify Portus’ <code class="highlighter-rouge">/v2/webhooks/events</code>
endpoint. This is used to synchronize the contents of the DB with the
registry. You can read more about this
<a href="/features/1_Synchronizing-the-Registry-and-Portus.html">here</a>.</li>
</ul>

<h2 id="integrating-the-registry-with-portus">Integrating the Registry with Portus</h2>

<p>From now on, we will suppose that a registry has already been created.</p>

<h3 id="how-does-portus-authorize-requests-">How does Portus authorize requests ?</h3>

<p>The next generation of Docker registries (those based on v2.0 or higher) push
the authorization of requests to an external authorization service. In our
case, this external authorization service will be Portus. If you would like to
have a more clear picture about this, take a look at this
<a href="https://github.com/docker/distribution/blob/master/docs/spec/auth/token.md#docker-registry-v2-authentication-via-central-service">explanation</a>
from Docker’s documentation.</p>

<p>When Portus receives an authorization request, it gets the following
information:</p>

<ul>
  <li>The registry being targeted. Portus has to know the existence of the registry
being targeted by the request. This is better explained in this
<a href="/docs/Configuring-the-registry.html">page</a>.</li>
  <li>Who is trying to perform the action. The user must be known to Portus, and
Portus will take into consideration whether the user is disabled, locked,
etc. If everything is fine, then it will check basic authorization data like
the password, etc.</li>
  <li>Which actions are trying to be performed.</li>
  <li>What is the target &lt;namespace&gt;/&lt;repo&gt;. Combining this with the given user
and the given action, Portus decides whether the user is authorized to
perform such action.</li>
</ul>

<p>If Portus decides that the user is authorized to perform the action, then it
sends a JWT token suitable for the docker registry being targeted. You can read
all the details about the format of this JWT token
<a href="https://github.com/docker/distribution/blob/master/docs/spec/auth/jwt.md">here</a>.</p>

<h3 id="configuring-the-jwt-token-sent-by-portus">Configuring the JWT token sent by Portus</h3>

<p>As stated in the previous section, the JWT token is used to handle the
authentication between Portus and your private registry. There are some
considerations in regards to this token.</p>

<p>First of all, it needs the <code class="highlighter-rouge">machine_fqdn</code> secret to be set. You can find this
in the <code class="highlighter-rouge">config/secrets.yml</code> file. If you change this file you should restart
Portus afterwards. Note that in production you can just provide the
<code class="highlighter-rouge">PORTUS_MACHINE_FQDN</code> environment variable.</p>

<p>Another thing to consider is the expiration time of the token itself. By default
it expires in 5 minutes. However, it’s possible that the image to be uploaded is
too big or the communication is too slow; and the upload can take more than 5
minutes. If this happens, then the upload will be cancelled from the registry’s
side, and it will fail. This is a known issue, and from Portus’ side we provide
<a href="/docs/Configuring-Portus.html#advanced-registry-options">this workaround</a>.</p>

<h3 id="synchronizing-the-registry-and-portus">Synchronizing the Registry and Portus</h3>

<p>As explained in <a href="/features/1_Synchronizing-the-Registry-and-Portus.html">this</a>
page, Portus is able to synchronize the contents of the registry and its
database. In this regard, there are some considerations to be made.</p>

<p>First of all, note that no synchronization will be made until the admin sets up
the registry in Portus’ database. This is better explained in this
<a href="/docs/Configuring-the-registry.html">page</a>.</p>

<p>Moreover, in order for this to happen, Portus needs the <code class="highlighter-rouge">portus</code> user to
exist. This is done automatically in
<a href="/docs/deploy.html#containerized">containerized</a> deployments. That being said,
if this is not your case, you have to create it after migrating the database by
performing:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ rake db:seed
</code></pre></div></div>

<p>or</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ rake portus:create_api_account
</code></pre></div></div>

<p>Note that neither of these commands will work if you have not set the
<code class="highlighter-rouge">portus_password</code> secret value in the <code class="highlighter-rouge">config/secrets.yml</code> file. This value can
be set on production with the environment variable <code class="highlighter-rouge">PORTUS_PASSWORD</code>.</p>

              </article>
            </div>
          </section>
        </div>
      </div>
      <aside class="hidden-xs hidden-sm content-list">
  <ul class="topics">
    <li>Documentation</li>
    <ul class="subtopics">
      
      
        
        <li>
          <a href="/docs/first-steps.html">
            Docker and Portus for newcomers
          </a>
        </li>
        
      
        
        <li>
          <a href="/docs/Configuring-Portus.html">
            Configuring Portus
          </a>
        </li>
        
      
        
        <li>
          <a href="/docs/database.html">
            Configuring the database
          </a>
        </li>
        
      
        
        <li>
          <a href="/docs/How-to-setup-secure-registry.html">
            Configuring a secure private registry
          </a>
        </li>
        
      
        
        <li>
          <a href="/docs/deploy.html">
            Deploying Portus
          </a>
        </li>
        
      
        
        <li>
          <a href="/docs/Configuring-the-registry.html">
            Portus and your private registry
          </a>
        </li>
        
      
        
        <li>
          <a href="/docs/assets.html">
            Managing assets
          </a>
        </li>
        
      
        
        <li>
          <a href="/docs/secrets.html">
            Using secrets
          </a>
        </li>
        
      
        
        <li>
          <a href="/docs/API.html">
            Portus REST API
          </a>
        </li>
        
      
        
        <li>
          <a href="/docs/background.html">
            The background process
          </a>
        </li>
        
      
        
        <li>
          <a href="/docs/portusctl.html">
            portusctl
          </a>
        </li>
        
      
        
        <li>
          <a href="/docs/upgrading-portus.html">
            Upgrading Portus
          </a>
        </li>
        
      
        
        <li>
          <a href="/docs/versions.html">
            Supported Docker Versions
          </a>
        </li>
        
      
        
        <li>
          <a href="/docs/debugging.html">
            Debugging Portus
          </a>
        </li>
        
      
        
        <li>
          <a href="/docs/how_we_release.html">
            Portus Releases
          </a>
        </li>
        
      
        
      
        
        <li>
          <a href="/docs/release-schedule.html">
            Release schedule
          </a>
        </li>
        
      
        
        <li>
          <a href="/docs/FAQ.html">
            FAQ
          </a>
        </li>
        
      
    </ul>
    <li>Features</li>
    <ul class="subtopics">
      
      
        <li>
          <a href="/features/1_Synchronizing-the-Registry-and-Portus.html">
            Synchonizing the Registry and Portus
          </a>
        </li>
      
        <li>
          <a href="/features/2_LDAP-support.html">
            LDAP support
          </a>
        </li>
      
        <li>
          <a href="/features/3_teams_namespaces_and_users.html">
            Teams, namespaces and users
          </a>
        </li>
      
        <li>
          <a href="/features/4_audit.html">
            Audit
          </a>
        </li>
      
        <li>
          <a href="/features/5_search.html">
            Search
          </a>
        </li>
      
        <li>
          <a href="/features/6_security_scanning.html">
            Security scanning
          </a>
        </li>
      
        <li>
          <a href="/features/removing_images.html">
            Removing images and tags
          </a>
        </li>
      
        <li>
          <a href="/features/6_starring.html">
            Starring repositories
          </a>
        </li>
      
        <li>
          <a href="/features/7_disabling_users.html">
            Removing/Disabling users
          </a>
        </li>
      
        <li>
          <a href="/features/anonymous_browsing.html">
            Anonymous browsing
          </a>
        </li>
      
        <li>
          <a href="/features/8_locking.html">
            Locking accounts for safety reasons
          </a>
        </li>
      
        <li>
          <a href="/features/9_recovering_password.html">
            Recovering the password
          </a>
        </li>
      
        <li>
          <a href="/features/disabling_signup.html">
            Disabling the sign up form
          </a>
        </li>
      
        <li>
          <a href="/features/oauth.html">
            OAuth and OpenID Connect support
          </a>
        </li>
      
        <li>
          <a href="/features/application_tokens.html">
            Application tokens
          </a>
        </li>
      
        <li>
          <a href="/features/display_name.html">
            Display name
          </a>
        </li>
      
        <li>
          <a href="/features/health.html">
            Health checking
          </a>
        </li>
      
    </ul>
  </ul>
  <div class="credits">
    <div class="text-center" lang="en">Created with <i class='fa fa-heart secondary-colour'></i> by the SUSE team</div>
  </div>
</aside>

      <div class="visible-xs visible-sm credits">
        <div class="text-center" lang="en">Created with <i class='fa fa-heart secondary-colour'></i> by the SUSE team</div>
      </div>
    </div>
  </body>
</html>
