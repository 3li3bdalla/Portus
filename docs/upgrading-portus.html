<!DOCTYPE html>
<html>
  <head>
    <title>Upgrading Portus</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Upgrading from 2.2 to 2.3">

    <link href="/stylesheets/portus.css"  type="text/css" rel="stylesheet" />
    <script src="/javascripts/dist/portus.min.js" type="text/javascript" charset="utf-8"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
  <script src="//oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="//oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->

<!-- Favicon for all different devices -->
<meta content="width=device-width, initial-scale=1" name="viewport" />
<link href="/images/favicon/apple-touch-icon-57x57.png" rel="apple-touch-icon" sizes="57x57" />
<link href="/images/favicon/apple-touch-icon-60x60.png" rel="apple-touch-icon" sizes="60x60" />
<link href="/images/favicon/apple-touch-icon-72x72.png" rel="apple-touch-icon" sizes="72x72" />
<link href="/images/favicon/apple-touch-icon-76x76.png" rel="apple-touch-icon" sizes="76x76" />
<link href="/images/favicon/apple-touch-icon-114x114.png" rel="apple-touch-icon" sizes="114x114" />
<link href="/images/favicon/apple-touch-icon-120x120.png" rel="apple-touch-icon" sizes="120x120" />
<link href="/images/favicon/apple-touch-icon-144x144.png" rel="apple-touch-icon" sizes="144x144" />
<link href="/images/favicon/apple-touch-icon-152x152.png" rel="apple-touch-icon" sizes="152x152" />
<link href="/images/favicon/apple-touch-icon-180x180.png" rel="apple-touch-icon" sizes="180x180" />
<link href="/images/favicon/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png" />
<link href="/images/favicon/android-chrome-192x192.png" rel="icon" sizes="192x192" type="image/png" />
<link href="/images/favicon/favicon-96x96.png" rel="icon" sizes="96x96" type="image/png" />
<link href="/images/favicon/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png" />
<link href="/images/favicon/manifest.json" rel="manifest" />
<link color="#205683" href="/images/favicon/safari-pinned-tab.svg" rel="mask-icon" />
<link href="/images/favicon/favicon.ico" rel="shortcut icon" />
<meta content="Portus" name="apple-mobile-web-app-title" />
<meta content="Portus" name="application-name" />
<meta content="#da532c" name="msapplication-TileColor" />
<meta content="/images/favicon/mstile-144x144.png" name="msapplication-TileImage" />
<meta content="/images/favicon/browserconfig.xml" name="msapplication-config" />
<meta content="#205683" name="theme-color" />

  </head>
  <body>
    <header id="portus-header" class="portus-topbar">
  <div class="container-fluid">
    <i id="open_main_menu" class="fa fa-bars fa-2x visible-xs menu-sandwich"></i>

    <a href="/">
      <img class="pull-left img-responsive topbar-logo" src="/images/logo-header.png" alt="Logo on header">
    </a>
    <div class="pull-right hidden-xs">
      <a class="btn btn-link" href="/blog/index.html">Blog</a>
      <a class="btn btn-link" href="/features.html">Features</a>
      <a class="btn btn-link" href="/documentation.html">Documentation</a>
    </div>
    <div class="clearfix"></div>
  </div>
</header>

<div id="mobile-menu" class="visible-xs mobile-menu">
  <ul>
    <li><i class="fa fa-list-ul"></i><a class="btn btn-link" href="/features.html">Features</a></li>
    <li><i class="fa fa-book"></i><a class="btn btn-link" href="/documentation.html">Documentation</a></li>
    <li><i class="fa fa-newspaper-o"></i><a class="btn btn-link" href="/blog/index.html">Blog</a></li>
    <li><i class="fa fa-question-circle"></i><a class="btn btn-link" href="/docs/FAQ.html">FAQ</a></li>
  </ul>
</div>

    <div class="container" id="documentation">
      <div class="row">
        <div class="post-content col-md-10 col-md-offset-3 col-sm-12 col-xs-12">
          <section>
            <div class="row">
              <div class="visible-xs visible-sm">
  <div class="content-bar">
    <ul class="topics">
      <li class="dropdown">
        <button class="dropdown-toggle" type="button" data-toggle="dropdown">Documentation Index
        <span class="caret"></span></button>
        <ul class="dropdown-menu">
          <li class="dropdown-header">Documentation</li>
          
          
            <li>
              <a href="/docs/first-steps.html">
                Docker and Portus for newcomers
              </a>
            </li>
          
            <li>
              <a href="/docs/Configuring-Portus.html">
                Configuring Portus
              </a>
            </li>
          
            <li>
              <a href="/docs/database.html">
                Configuring the database
              </a>
            </li>
          
            <li>
              <a href="/docs/How-to-setup-secure-registry.html">
                Configuring a secure private registry
              </a>
            </li>
          
            <li>
              <a href="/docs/deploy.html">
                Deploying Portus
              </a>
            </li>
          
            <li>
              <a href="/docs/Configuring-the-registry.html">
                Portus and your private registry
              </a>
            </li>
          
            <li>
              <a href="/docs/assets.html">
                Managing assets
              </a>
            </li>
          
            <li>
              <a href="/docs/secrets.html">
                Using secrets
              </a>
            </li>
          
            <li>
              <a href="/docs/API.html">
                Portus REST API
              </a>
            </li>
          
            <li>
              <a href="/docs/background.html">
                The background process
              </a>
            </li>
          
            <li>
              <a href="/docs/portusctl.html">
                portusctl
              </a>
            </li>
          
            <li>
              <a href="/docs/upgrading-portus.html">
                Upgrading Portus
              </a>
            </li>
          
            <li>
              <a href="/docs/versions.html">
                Supported Docker Versions
              </a>
            </li>
          
            <li>
              <a href="/docs/debugging.html">
                Debugging Portus
              </a>
            </li>
          
            <li>
              <a href="/docs/how_we_release.html">
                Portus Releases
              </a>
            </li>
          
            <li>
              <a href="/docs/release-schedule.html">
                Release schedule
              </a>
            </li>
          
            <li>
              <a href="/docs/FAQ.html">
                FAQ
              </a>
            </li>
          
          <li class="dropdown-header">Features</li>
          
          
            <li>
              <a href="/features/1_Synchronizing-the-Registry-and-Portus.html">
                Synchonizing the Registry and Portus
              </a>
            </li>
          
            <li>
              <a href="/features/2_LDAP-support.html">
                LDAP support
              </a>
            </li>
          
            <li>
              <a href="/features/3_teams_namespaces_and_users.html">
                Teams, namespaces and users
              </a>
            </li>
          
            <li>
              <a href="/features/4_audit.html">
                Audit
              </a>
            </li>
          
            <li>
              <a href="/features/5_search.html">
                Search
              </a>
            </li>
          
            <li>
              <a href="/features/6_security_scanning.html">
                Security scanning
              </a>
            </li>
          
            <li>
              <a href="/features/removing_images.html">
                Removing images and tags
              </a>
            </li>
          
            <li>
              <a href="/features/6_starring.html">
                Starring repositories
              </a>
            </li>
          
            <li>
              <a href="/features/7_disabling_users.html">
                Removing/Disabling users
              </a>
            </li>
          
            <li>
              <a href="/features/anonymous_browsing.html">
                Anonymous browsing
              </a>
            </li>
          
            <li>
              <a href="/features/8_locking.html">
                Locking accounts for safety reasons
              </a>
            </li>
          
            <li>
              <a href="/features/9_recovering_password.html">
                Recovering the password
              </a>
            </li>
          
            <li>
              <a href="/features/disabling_signup.html">
                Disabling the sign up form
              </a>
            </li>
          
            <li>
              <a href="/features/oauth.html">
                OAuth and OpenID Connect support
              </a>
            </li>
          
            <li>
              <a href="/features/application_tokens.html">
                Application tokens
              </a>
            </li>
          
            <li>
              <a href="/features/display_name.html">
                Display name
              </a>
            </li>
          
            <li>
              <a href="/features/health.html">
                Health checking
              </a>
            </li>
          
        </ul>
      </li>
    </ul>
  </div>
</div>

            </div>
            <div class="row post">
              <article>
                <h2 id="upgrading-from-22-to-23">Upgrading from 2.2 to 2.3</h2>

<div class="alert alert-info">
  <strong>Important note</strong>: before doing anything at all, make sure to
  backup the contents of the database.
</div>

<p>Puma is now the HTTP server being used. Make sure to use the
<code class="highlighter-rouge">PORTUS_PUMA_TLS_KEY</code> and the <code class="highlighter-rouge">PORTUS_PUMA_TLS_CERT</code> environment variables to
point puma to the right paths for the certificates. Moreover, if you are not
using the official Docker image, you will have to use the <code class="highlighter-rouge">PORTUS_PUMA_HOST</code>
environment variable to tell Puma where to bind itself (in containerized
deployments it will bind by default to <code class="highlighter-rouge">0.0.0.0:3000</code>).</p>

<p>The database environment variables have changed the prefix from
<code class="highlighter-rouge">PORTUS_PRODUCTION_</code> to <code class="highlighter-rouge">PORTUS_DB_</code>. Moreover, you will be able now to provide
values for the following items: adapter (set it to <code class="highlighter-rouge">postgresql</code> for PostgreSQL
support), port, pool and timeout. All these values are prefixed by <code class="highlighter-rouge">PORTUS_DB_</code>
as well, so for example, to provide a value for the pool you need to set
<code class="highlighter-rouge">PORTUS_DB_POOL</code>.</p>

<p>Finally, we are not running migrations automatically anymore as we used to do
before. This is now to be done by the administrator by executing (on the Portus
context in <code class="highlighter-rouge">/srv/Portus</code> or simply as part of a <code class="highlighter-rouge">docker exec</code> command):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ portusctl exec rake db:migrate
</code></pre></div></div>

<p>For more details on this check the commits
<a href="https://github.com/SUSE/Portus/commit/7fdfe96341801b492ca0e2637fcbb0d31e54d5fc">7fdfe9634180</a>
and
<a href="https://github.com/SUSE/Portus/commit/1c4d2b6cf0e09e3be770a0675a42ee23cd2f62dd">1c4d2b6cf0e0</a>.</p>

<h2 id="upgrading-from-21-to-22">Upgrading from 2.1 to 2.2</h2>

<div class="alert alert-info">
  <strong>Important note</strong>: before doing anything at all, make sure to
  backup the contents of the database.
</div>

<p>In order to upgrade from 2.1 to 2.2, you only need to perform a database
migration. So, with the new code in place, simply run the following (wrap it
with <code class="highlighter-rouge">portusctl</code> if you are using the RPM for openSUSE/SLE):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ rake db:migrate
</code></pre></div></div>

<p>And you should be all set!</p>

<h2 id="upgrading-from-20-to-21">Upgrading from 2.0 to 2.1</h2>

<h3 id="changes-on-the-configuration">Changes on the configuration</h3>

<p>First of all, one of the breaking changes from 2.0 to 2.1 is that the machine
FQDN is no longer considered a secret, but a mere configuration value. In order
to provide a smoother transition, in Portus 2.0.5 we allow the FQDN to be
specified in either the <code class="highlighter-rouge">config/secrets.yml</code> file or as a proper configurable
value (see <a href="https://github.com/SUSE/Portus/commit/f0850459cc43e9b9258e70867d5608f2ef303f3e">this</a> commit).
This configurable option is defined like this:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">machine_fqdn</span><span class="pi">:</span>
  <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">portus.test.lan"</span></code></pre></figure>

<p>Therefore, just provide the same value as you had from the <code class="highlighter-rouge">config/secrets.yml</code>
file, into the <code class="highlighter-rouge">config/config-local.yml</code> file or the <code class="highlighter-rouge">PORTUS_MACHINE_FQDN_VALUE</code>
environment variable.</p>

<p>Another breaking change is the <code class="highlighter-rouge">jwt_expiration_time</code> configuration option. Now,
instead of being a standalone option, it’s been put inside of the <code class="highlighter-rouge">registry</code>
configuration. So, now instead of:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="s">jwt_expiration_time</span>
  <span class="s">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">5.minutes"</span></code></pre></figure>

<p>The current configuration is like this:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">registry</span><span class="pi">:</span>
  <span class="na">jwt_expiration_time</span><span class="pi">:</span>
    <span class="na">value</span><span class="pi">:</span> <span class="s">5</span></code></pre></figure>

<p>Moreover, as you can see, the value of <code class="highlighter-rouge">jwt_expiration_time</code> has been
simplified. Now, instead of <code class="highlighter-rouge">"5.minutes"</code> you have to specify it like this
<code class="highlighter-rouge">5</code>. The expiration time is now represented in minutes, so it no longer needs
to be specified explicitly. The <code class="highlighter-rouge">"5.minutes"</code> format is still supported, but this
support will be removed in the future.</p>

<p>Besides all that, there have been lots of additions in the configuration that
you can check out <a href="/docs/Configuring-Portus.html">here</a>.</p>

<h3 id="upgrading-the-database">Upgrading the database</h3>

<div class="alert alert-info">
  <strong>Important note</strong>: before doing anything at all, make sure to
  backup the contents of the database.
</div>

<p>With the new code in place, simply run the following (wrap it with <code class="highlighter-rouge">portusctl</code>
if you are using the RPM for openSUSE/SLE):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ rake db:migrate
$ rake migrate:update_personal_namespaces
</code></pre></div></div>

<p>After that, if you are using an LDAP server for authentication, run the following:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ rake migrate:update_ldap_names
</code></pre></div></div>

<p>The previous task will list the users which are to be updated, and then
it will ask you whether you want to proceed or not. If you don’t want this task
to ask you this question (make it non-interactive), simply set the
<code class="highlighter-rouge">PORTUS_FORCE_LDAP_NAME_UPDATE</code> environment variable before running the rake
task (Note that it will only check the existence of the environment variable,
not its value).</p>

<p>Finally, as an optional step, you might want to execute the following task:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ rake portus:update_tags
</code></pre></div></div>

<p>This task will fill the database with the digest and the image ID of all the
tags stored in the database. This will take a lot of time if you have lots of
images and tags in your Portus instance. For this reason, we recommend setting
the registry to <code class="highlighter-rouge">readonly</code> mode before performing this operation, just to avoid
any concurrency issues. Moreover, this task also asks for confirmation before
doing anything at all. You can skip this by setting the
<code class="highlighter-rouge">PORTUS_FORCE_DIGEST_UPDATE</code> environment variable before calling the rake task.</p>

              </article>
            </div>
          </section>
        </div>
      </div>
      <aside class="hidden-xs hidden-sm content-list">
  <ul class="topics">
    <li>Documentation</li>
    <ul class="subtopics">
      
      
        <li>
          <a href="/docs/first-steps.html">
            Docker and Portus for newcomers
          </a>
        </li>
      
        <li>
          <a href="/docs/Configuring-Portus.html">
            Configuring Portus
          </a>
        </li>
      
        <li>
          <a href="/docs/database.html">
            Configuring the database
          </a>
        </li>
      
        <li>
          <a href="/docs/How-to-setup-secure-registry.html">
            Configuring a secure private registry
          </a>
        </li>
      
        <li>
          <a href="/docs/deploy.html">
            Deploying Portus
          </a>
        </li>
      
        <li>
          <a href="/docs/Configuring-the-registry.html">
            Portus and your private registry
          </a>
        </li>
      
        <li>
          <a href="/docs/assets.html">
            Managing assets
          </a>
        </li>
      
        <li>
          <a href="/docs/secrets.html">
            Using secrets
          </a>
        </li>
      
        <li>
          <a href="/docs/API.html">
            Portus REST API
          </a>
        </li>
      
        <li>
          <a href="/docs/background.html">
            The background process
          </a>
        </li>
      
        <li>
          <a href="/docs/portusctl.html">
            portusctl
          </a>
        </li>
      
        <li>
          <a href="/docs/upgrading-portus.html">
            Upgrading Portus
          </a>
        </li>
      
        <li>
          <a href="/docs/versions.html">
            Supported Docker Versions
          </a>
        </li>
      
        <li>
          <a href="/docs/debugging.html">
            Debugging Portus
          </a>
        </li>
      
        <li>
          <a href="/docs/how_we_release.html">
            Portus Releases
          </a>
        </li>
      
        <li>
          <a href="/docs/release-schedule.html">
            Release schedule
          </a>
        </li>
      
        <li>
          <a href="/docs/FAQ.html">
            FAQ
          </a>
        </li>
      
    </ul>
    <li>Features</li>
    <ul class="subtopics">
      
      
        <li>
          <a href="/features/1_Synchronizing-the-Registry-and-Portus.html">
            Synchonizing the Registry and Portus
          </a>
        </li>
      
        <li>
          <a href="/features/2_LDAP-support.html">
            LDAP support
          </a>
        </li>
      
        <li>
          <a href="/features/3_teams_namespaces_and_users.html">
            Teams, namespaces and users
          </a>
        </li>
      
        <li>
          <a href="/features/4_audit.html">
            Audit
          </a>
        </li>
      
        <li>
          <a href="/features/5_search.html">
            Search
          </a>
        </li>
      
        <li>
          <a href="/features/6_security_scanning.html">
            Security scanning
          </a>
        </li>
      
        <li>
          <a href="/features/removing_images.html">
            Removing images and tags
          </a>
        </li>
      
        <li>
          <a href="/features/6_starring.html">
            Starring repositories
          </a>
        </li>
      
        <li>
          <a href="/features/7_disabling_users.html">
            Removing/Disabling users
          </a>
        </li>
      
        <li>
          <a href="/features/anonymous_browsing.html">
            Anonymous browsing
          </a>
        </li>
      
        <li>
          <a href="/features/8_locking.html">
            Locking accounts for safety reasons
          </a>
        </li>
      
        <li>
          <a href="/features/9_recovering_password.html">
            Recovering the password
          </a>
        </li>
      
        <li>
          <a href="/features/disabling_signup.html">
            Disabling the sign up form
          </a>
        </li>
      
        <li>
          <a href="/features/oauth.html">
            OAuth and OpenID Connect support
          </a>
        </li>
      
        <li>
          <a href="/features/application_tokens.html">
            Application tokens
          </a>
        </li>
      
        <li>
          <a href="/features/display_name.html">
            Display name
          </a>
        </li>
      
        <li>
          <a href="/features/health.html">
            Health checking
          </a>
        </li>
      
    </ul>
  </ul>
  <div class="credits">
    <div class="text-center" lang="en">Created with <i class='fa fa-heart secondary-colour'></i> by the SUSE team</div>
  </div>
</aside>

      <div class="visible-xs visible-sm credits">
        <div class="text-center" lang="en">Created with <i class='fa fa-heart secondary-colour'></i> by the SUSE team</div>
      </div>
    </div>
  </body>
</html>
